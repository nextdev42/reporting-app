<!DOCTYPE html>
<html lang="sw">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ripoti za <%= username %></title>
<link rel="stylesheet" href="/css/user-reports.css">
</head>
<body>

<nav>
  <h1>Ripoti za <%= username %></h1>
  <div class="nav-actions">
    <span>Umeingia kama: <strong><%= loggedInUser %></strong></span>
    <button onclick="location.href='/dashboard.html'">Nyumbani</button>
    <button onclick="location.href='/logout'">Toka</button>
  </div>
</nav>

<div class="container">
  <div class="user-header">
    <img id="userAvatar" src="https://ui-avatars.com/api/?name=<%= username %>&background=405DE6&color=fff" alt="avatar">
    <div class="info">
      <h2>Ripoti za <strong><%= username %></strong></h2>
      <div class="stats">
        <span id="totalPosts">0 Ripoti</span>
        <span id="totalThumbsUp">0 üëç</span>
        <span id="totalThumbsDown">0 üëé</span>
      </div>
      <% if(username === loggedInUser){ %>
      <form id="avatarForm" class="avatar-upload">
        <input type="file" name="avatar" accept="image/*">
        <button type="submit">Update Avatar</button>
      </form>
      <% } %>
    </div>
  </div>

  <div id="reports-container" class="reports-grid"></div>
</div>

<script>
const username = "<%= username %>";
const loggedInUser = "<%= loggedInUser %>";
let totalP = 0, totalUp = 0, totalDown = 0;

// Convert @username to clickable links
function linkUsernames(text) {
  return text.replace(/@(\w+)/g, '<a href="/user/$1" class="mention">@$1</a>');
}

function createReportCard(r){
  const card = document.createElement('div');
  card.className = "card";
  const totalComments = r.comments.length || 0;

  card.innerHTML = `
    <div class="card-header">
      <div class="report-avatar">${r.username.charAt(0).toUpperCase()}</div>
      <div>
        <div class="report-title">${linkUsernames(r.title||'')}</div>
        <div class="report-meta">${r.username} - ${r.clinic} | ${r.timestamp}</div>
      </div>
    </div>
    <div class="report-description">${linkUsernames(r.description||'')}</div>
    ${r.image ? `<img class="report-image" src="${r.image}">` : ''}
    <div class="card-footer">
      <div class="reaction-container">
        <div class="report-thumbs">
          <span>üëç <span class="thumbs-up">${r.thumbs_up||0}</span></span>
          <span>üëé <span class="thumbs-down">${r.thumbs_down||0}</span></span>
        </div>
        <span class="comment-toggle">üí¨ ${totalComments} Maoni</span>
      </div>
      <div class="report-comments">
        <ul class="comments-list"></ul>
        <form class="comment-form">
          <input type="text" name="comment" placeholder="Andika maoni..." required/>
          <button type="submit">Tuma</button>
        </form>
      </div>
    </div>
  `;

  totalP++; 
  totalUp += r.thumbs_up || 0; 
  totalDown += r.thumbs_down || 0;

  const ul = card.querySelector('.comments-list');
  r.comments.forEach(c=>{
    const li = document.createElement('li');
    li.className = 'comment-item';
    li.innerHTML = `
      <div class="comment-avatar">${c.username.charAt(0).toUpperCase()}</div>
      <div>
        <div class="comment-user">${c.username}</div>
        <div class="comment-text">${linkUsernames(c.comment)}</div>
        <div class="comment-time">${c.timestamp}</div>
      </div>`;
    ul.appendChild(li);
  });

  const toggleBtn = card.querySelector('.comment-toggle');
  const commentSection = card.querySelector('.report-comments');
  toggleBtn.addEventListener('click', () => commentSection.classList.toggle('active'));

  const form = card.querySelector('.comment-form');
  if(r.username === loggedInUser){ form.style.display = 'none'; }

  form.addEventListener('submit', async(e) => {
    e.preventDefault();
    const input = form.comment;
    if(!input.value.trim()) return;
    const txt = input.value;
    input.value = "";
    try {
      const res = await fetch(`/api/comments/${r.id}`, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({comment: txt})
      });
      if(!res.ok) throw new Error();
      const c = await res.json();
      const li = document.createElement('li');
      li.className = 'comment-item';
      li.innerHTML = `
        <div class="comment-avatar">${c.username.charAt(0).toUpperCase()}</div>
        <div>
          <div class="comment-user">${c.username}</div>
          <div class="comment-text">${linkUsernames(c.comment)}</div>
          <div class="comment-time">${c.timestamp}</div>
        </div>`;
      ul.prepend(li);
      toggleBtn.innerHTML = `üí¨ ${ul.children.length} Maoni`;
    } catch(err) { alert("Tatizo kutuma maoni"); }
  });

  return card;
}

function createReportCard(r){
  const card = document.createElement('div');
  card.className = "card";
  const totalComments = r.comments.length || 0;

  card.innerHTML = `
    <div class="card-header">
      <div class="report-avatar"><a href="/user/${r.username}">${r.username.charAt(0).toUpperCase()}</a></div>
      <div>
        <div class="report-title">${linkUsernames(r.title||'')}</div>
        <div class="report-meta"><a href="/user/${r.username}">${r.username}</a> - ${r.clinic} | ${r.timestamp}</div>
      </div>
    </div>
    <div class="report-description">${linkUsernames(r.description||'')}</div>
    ${r.image ? `<img class="report-image" src="${r.image}">` : ''}
    <div class="card-footer">
      <div class="reaction-container">
        <div class="report-thumbs">
          <span>üëç <span class="thumbs-up">${r.thumbs_up||0}</span></span>
          <span>üëé <span class="thumbs-down">${r.thumbs_down||0}</span></span>
        </div>
        <span class="comment-toggle">üí¨ ${totalComments} Maoni</span>
      </div>
      <div class="report-comments">
        <ul class="comments-list"></ul>
        <form class="comment-form">
          <input type="text" name="comment" placeholder="Andika maoni..." required/>
          <button type="submit">Tuma</button>
        </form>
      </div>
    </div>
  `;

  totalP++; 
  totalUp += r.thumbs_up || 0; 
  totalDown += r.thumbs_down || 0;

  const ul = card.querySelector('.comments-list');
  r.comments.forEach(c=>{
    const li = document.createElement('li');
    li.className = 'comment-item';
    li.innerHTML = `
      <div class="comment-avatar"><a href="/user/${c.username}">${c.username.charAt(0).toUpperCase()}</a></div>
      <div>
        <div class="comment-user"><a href="/user/${c.username}">${c.username}</a></div>
        <div class="comment-text">${linkUsernames(c.comment)}</div>
        <div class="comment-time">${c.timestamp}</div>
      </div>`;
    ul.appendChild(li);
  });

  const toggleBtn = card.querySelector('.comment-toggle');
  const commentSection = card.querySelector('.report-comments');
  toggleBtn.addEventListener('click', () => commentSection.classList.toggle('active'));

  const form = card.querySelector('.comment-form');
  // only hide form if the logged in user is the report author
  if(r.username === loggedInUser) form.style.display = 'none';
  else form.style.display = 'flex'; // show the form for others

  form.addEventListener('submit', async(e) => {
    e.preventDefault();
    const input = form.comment;
    if(!input.value.trim()) return;
    const txt = input.value;
    input.value = "";
    try {
      const res = await fetch(`/api/comments/${r.id}`, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({comment: txt})
      });
      if(!res.ok) throw new Error();
      const c = await res.json();
      const li = document.createElement('li');
      li.className = 'comment-item';
      li.innerHTML = `
        <div class="comment-avatar"><a href="/user/${c.username}">${c.username.charAt(0).toUpperCase()}</a></div>
        <div>
          <div class="comment-user"><a href="/user/${c.username}">${c.username}</a></div>
          <div class="comment-text">${linkUsernames(c.comment)}</div>
          <div class="comment-time">${c.timestamp}</div>
        </div>`;
      ul.prepend(li);
      toggleBtn.innerHTML = `üí¨ ${ul.children.length} Maoni`;
    } catch(err) { alert("Tatizo kutuma maoni"); }
  });

  return card;
}
async function loadReports(){
  const wrap = document.getElementById('reports-container');
  wrap.innerHTML = "<div>Inapakia...</div>";
  try {
    const res = await fetch(`/api/reports?username=${encodeURIComponent(username)}`);
    const data = await res.json();
    wrap.innerHTML = "";
    data.reports.forEach(r => wrap.appendChild(createReportCard(r)));

    document.getElementById('totalPosts').textContent = totalP + " Ripoti";
    document.getElementById('totalThumbsUp').textContent = totalUp + " üëç";
    document.getElementById('totalThumbsDown').textContent = totalDown + " üëé";
  } catch(err) {
    wrap.innerHTML = `<div class="error">Hitilafu katika kupakia ripoti</div>`;
    console.error(err);
  }
}

loadReports();
</script>

</body>
</html>
