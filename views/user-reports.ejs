<!DOCTYPE html>
<html lang="sw">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ripoti za <%= username %></title>
<link rel="stylesheet" href="/dashboard.css" />
<!-- keep your instagram UI CSS -->
<style>
/* ----- PLACE ALL THE CSS YOU GAVE (var --primary, nav, user-header etc...) HERE WITHOUT CHANGES ---- */
</style>
</head>
<body>

<nav>
  <h1>Ripoti za Kliniki</h1>
  <div class="nav-actions">
    <span>Umeingia kama: <strong><%= loggedInUser %></strong></span>
    <button onclick="location.href='/dashboard.html'">Nyumbani</button>
    <button onclick="location.href='/logout'">Toka</button>
  </div>
</nav>

<div class="container">
  <!-- USER HEADER -->
  <div class="user-header">
    <img id="userAvatar" src="/default-avatar.png" alt="Avatar">
    <div class="info">
      <h2>Unaangalia ripoti za <%= username %></h2>
      <div class="stats">
        <span id="totalPosts">0 Ripoti</span>
        <span id="totalThumbsUp">0 üëç</span>
        <span id="totalThumbsDown">0 üëé</span>
      </div>

      <% if(loggedInUser === username){ %>
      <form id="avatarForm" class="avatar-upload">
        <input type="file" name="avatar" accept="image/*" required>
        <button type="submit">Update Avatar</button>
      </form>
      <% } %>
    </div>
  </div>

  <!-- GRID FOR POSTS -->
  <div id="reports-container" class="reports-grid"></div>
</div>

<!-- TEMPLATE (for cloning) -->
<template id="cardTpl">
  <div class="card report-card">
    <div class="card-header">
      <img class="report-avatar" src="/default-avatar.png" alt="avatar">
      <div class="card-header-content">
        <h3 class="report-title"></h3>
        <p class="report-meta"></p>
      </div>
    </div>
    <div class="card-body">
      <p class="report-description"></p>
      <img class="report-image" style="display:none;">
    </div>
    <div class="card-footer">
      <div class="report-thumbs">
        <span>üëç <span class="thumbs-up">0</span></span>
        <span>üëé <span class="thumbs-down">0</span></span>
      </div>
      <div class="report-comments">
        <h4>Maoni:</h4>
        <ul class="comments-list"></ul>
        <form class="comment-form">
          <input type="text" name="comment" placeholder="Andika maoni..." required>
          <button type="submit">Tuma</button>
        </form>
      </div>
    </div>
  </div>
</template>

<script>
const username    = "<%= username %>";
const loggedUser  = "<%= loggedInUser %>";

// Fetch user avatar if you will provide /api/useravatar?u=
fetch(`/api/useravatar?u=${encodeURIComponent(username)}`)
  .then(r=>r.json()).then(d=>{
    document.getElementById('userAvatar').src = d.avatar || "/default-avatar.png";
  }).catch(()=>{});

// Fetch reports dynamically
(async()=>{
  try{
    const r = await fetch(`/api/reports?username=${encodeURIComponent(username)}`);
    const data = await r.json();
    displayStats(data.reports);
    data.reports.forEach(buildCard);
  }catch(e){
    document.getElementById('reports-container').innerHTML="<p>Tatizo kupata ripoti...</p>";
  }
})();

function displayStats(list){
  const total   = list.length,
        up      = list.reduce((n,r)=>n+r.thumbs_up,0),
        down    = list.reduce((n,r)=>n+r.thumbs_down,0);
  document.getElementById('totalPosts').innerText = `${total} Ripoti`;
  document.getElementById('totalThumbsUp').innerText = `${up} üëç`;
  document.getElementById('totalThumbsDown').innerText = `${down} üëé`;
}

function buildCard(r){
  const tpl   = document.getElementById('cardTpl');
  const clone = tpl.content.cloneNode(true);
  
  // basic info
  clone.querySelector('.report-title').innerText = r.title || '';
  clone.querySelector('.report-description').innerText = r.description || '';
  clone.querySelector('.report-meta').innerText = `${r.username} - ${r.clinic} | ${r.timestamp}`;
  
  // avatar
  clone.querySelector('.report-avatar').src = r.avatar || '/default-avatar.png';
  
  // photo
  if(r.image){
    const img = clone.querySelector('.report-image');
    img.src = r.image;
    img.style.display = "block";
  }
  
  // thumbs
  clone.querySelector('.thumbs-up').innerText   = r.thumbs_up || 0;
  clone.querySelector('.thumbs-down').innerText = r.thumbs_down || 0;
  if(r.username === loggedUser){
    clone.querySelector('.report-thumbs').style.pointerEvents="none";
  }
  
  // comments
  const ul = clone.querySelector('.comments-list');
  r.comments.forEach(c=>{
    const li=document.createElement('li');
    li.className="comment-item";
    li.innerHTML = `
      <img class="comment-avatar" src="${c.avatar||'/default-avatar.png'}">
      <div class="comment-content">
        <div class="comment-user">${c.username}</div>
        <div class="comment-text">${c.comment}</div>
        <div class="comment-time">${c.timestamp}</div>
      </div>`;
    ul.appendChild(li);
  });

  // post comment
  clone.querySelector('.comment-form').addEventListener('submit', async(e)=>{
    e.preventDefault();
    const text = e.target.comment.value.trim();
    if(!text) return;
    const res = await fetch(`/api/comments/${r.id}`,{
      method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({comment:text})
    });
    const newC = await res.json();
    const li   = document.createElement('li');
    li.className="comment-item";
    li.innerHTML = `
      <img class="comment-avatar" src="${newC.avatar||'/default-avatar.png'}">
      <div class="comment-content">
         <div class="comment-user">${newC.username}</div>
         <div class="comment-text">${newC.comment}</div>
         <div class="comment-time">${newC.timestamp}</div>
      </div>`;
    ul.prepend(li);
    e.target.reset();
  });

  document.getElementById('reports-container').appendChild(clone);
}
</script>
</body>
</html>
