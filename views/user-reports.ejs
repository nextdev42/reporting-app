<!DOCTYPE html>
<html lang="sw">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ripoti za <%= username %></title>
<link rel="stylesheet" href="/dashboard.css"><!-- reuse dashboard look -->
<style>
  /* user page specific tweaks */
  .user-header {
    display:flex;align-items:center;gap:20px;margin-bottom:20px;
    background:white;padding:20px;border-radius:12px;box-shadow:0 2px 6px rgba(0,0,0,0.1);
  }
  .user-avatar {
    width:100px;height:100px;border-radius:50%;background:#4CAF50;
    display:flex;align-items:center;justify-content:center;color:#fff;
    font-size:2.5rem;font-weight:bold;
  }
  .stats {display:flex;gap:20px;margin-top:10px;}
  .stats span {font-weight:bold;}
  .reports-grid {display:grid;grid-template-columns:repeat(auto-fill,minmax(350px,1fr));gap:25px;}
</style>
</head>
<body>

<nav>
  <h1>Ripoti za Kliniki</h1>
  <div class="nav-actions">
    <span>Umeingia kama: <strong><%= loggedInUser %></strong></span>
    <button onclick="location.href='/dashboard.html'">Nyumbani</button>
    <button onclick="location.href='/logout'">Toka</button>
  </div>
</nav>

<div class="container">

  <!-- Header -->
  <div class="user-header">
    <div id="userAvatar" class="user-avatar"><%= username.charAt(0).toUpperCase() %></div>
    <div>
      <h2>Unaangalia ripoti za <strong><%= username %></strong></h2>
      <div class="stats">
        <span id="totalPosts">0 Ripoti</span>
        <span id="totalThumbsUp">0 üëç</span>
        <span id="totalThumbsDown">0 üëé</span>
      </div>
      <form id="avatarForm" class="avatar-upload" enctype="multipart/form-data">
        <input type="file" name="avatar" accept="image/*" required>
        <button type="submit">Update Avatar</button>
      </form>
    </div>
  </div>

  <!-- Reports -->
  <div id="reports-container" class="reports-grid"></div>
</div>

<script>
  const username = "<%= username %>";
  const reportsContainer = document.getElementById('reports-container');
  const totalPostsEl = document.getElementById('totalPosts');
  const upEl   = document.getElementById("totalThumbsUp");
  const downEl = document.getElementById("totalThumbsDown");

  async function fetchReports(){
    const res = await fetch(`/api/reports?username=${encodeURIComponent(username)}`);
    const {reports} = await res.json();

    let totalUp=0,totalDown=0;
    totalPostsEl.textContent = reports.length+" Ripoti";

    reportsContainer.innerHTML="";
    reports.forEach(r=>{
      totalUp += (r.thumbs_up||0);
      totalDown += (r.thumbs_down||0);

      const card = document.createElement("div");
      card.className="card";

      card.innerHTML = `
        <div class="card-header">
          <div class="report-avatar" style="background:#4CAF50;color:#fff;display:flex;align-items:center;justify-content:center;">
            ${r.username.charAt(0).toUpperCase()}
          </div>
          <div class="card-header-content">
            <h3 class="report-title">${r.title||''}</h3>
            <p class="report-meta">${r.username} - ${r.clinic} | ${r.timestamp}</p>
          </div>
        </div>
        <div class="card-body">
          <p class="report-description">${r.description}</p>
          ${r.image?`<img class="report-image" style="display:block;" src="${r.image}"/>`:""}
        </div>
        <div class="card-footer">
          <div class="report-thumbs">
            <span>üëç <span class="thumbs-up">${r.thumbs_up||0}</span></span>
            <span>üëé <span class="thumbs-down">${r.thumbs_down||0}</span></span>
          </div>
          <div class="report-comments">
            <h4>Maoni:</h4>
            <ul class="comments-list">
              ${r.comments.map(c=>
                `<li class="comment-item">
                  <div class="comment-avatar" style="background:#4CAF50;color:#fff;display:flex;align-items:center;justify-content:center;">
                        ${c.username.charAt(0).toUpperCase()}
                  </div>
                  <div class="comment-content">
                    <div class="comment-user">${c.username}</div>
                    <div class="comment-text">${c.comment}</div>
                    <div class="comment-time">${c.timestamp}</div>
                  </div>
                </li>`).join("")}
            </ul>
            <form class="comment-form">
              <input type="text" name="comment" placeholder="Andika maoni..." required>
              <button type="submit">Tuma</button>
            </form>
          </div>
        </div>
      `;

      const form = card.querySelector('.comment-form');
      const list = card.querySelector('.comments-list');
      form.addEventListener("submit",async(e)=>{
        e.preventDefault();
        const txt = form.comment.value.trim();
        if(!txt) return;
        const res = await fetch(`/api/comments/${r.id}`,{
          method:"POST",headers:{"Content-Type":"application/json"},
          body:JSON.stringify({comment:txt})
        });
        const saved = await res.json();
        const li = document.createElement("li");
        li.className="comment-item";
        li.innerHTML = `
            <div class="comment-avatar" style="background:#4CAF50;color:#fff;display:flex;align-items:center;justify-content:center;">
              ${saved.username.charAt(0).toUpperCase()}
            </div>
            <div class="comment-content">
              <div class="comment-user">${saved.username}</div>
              <div class="comment-text">${saved.comment}</div>
              <div class="comment-time">${saved.timestamp}</div>
            </div>`;
        list.prepend(li);
        form.reset();
      });

      reportsContainer.appendChild(card);
    });

    upEl.textContent = totalUp + " üëç";
    downEl.textContent = totalDown + " üëé";
  }
  fetchReports();

  // avatar upload
  document.getElementById("avatarForm").addEventListener("submit",async(e)=>{
    e.preventDefault();
    const fd = new FormData(e.target);
    const res = await fetch(`/update-avatar?user=${encodeURIComponent(username)}`,{
      method:"POST",body:fd
    });
    if(res.ok){ alert("Avatar updated"); location.reload(); }
    else alert("Tatizo ku-upload");
  });
</script>
</body>
</html>
