<!DOCTYPE html>
<html lang="sw">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ripoti za <%= username %></title>
<link rel="stylesheet" href="/dashboard.css"><!-- so colors match dashboard -->
<!-- include the instagram-style internal css here -->
<style>
/* ğŸ‘‡ paste the CSS you provided exactly here (var --primary etc...) */
</style>
</head>
<body>

<nav>
  <h1>Ripoti za Kliniki</h1>
  <div class="nav-actions">
    <span>Umeingia kama: <strong><%= loggedInUser %></strong></span>
    <button onclick="location.href='/dashboard.html'">Nyumbani</button>
    <button onclick="location.href='/logout'">Toka</button>
  </div>
</nav>

<div class="container">
  <div class="user-header">
    <img id="userAvatar" src="/default-avatar.png" alt="Avatar">
    <div class="info">
      <h2>Unaangalia ripoti za <%= username %></h2>
      <div class="stats">
        <span id="totalPosts">0 Ripoti</span>
        <span id="totalThumbsUp">0 ğŸ‘</span>
        <span id="totalThumbsDown">0 ğŸ‘</span>
      </div>
      <% if(username === loggedInUser){ %>
      <form id="avatarForm" class="avatar-upload">
        <input type="file" name="avatar" accept="image/*" required>
        <button type="submit">Update Avatar</button>
      </form>
      <% } %>
    </div>
  </div>

  <div id="reports-container" class="reports-grid">
    <!-- report cards injected by JS -->
  </div>
</div>


<!-- Template for cards -->
<template id="cardTpl">
  <div class="card report-card">
    <div class="card-header">
      <img class="report-avatar" src="/default-avatar.png">
      <div class="card-header-content">
        <h3 class="report-title"></h3>
        <p class="report-meta"></p>
      </div>
    </div>
    <div class="card-body">
      <p class="report-description"></p>
      <img class="report-image" style="display:none;">
    </div>
    <div class="card-footer">
      <div class="report-thumbs">
          <span>ğŸ‘ <span class="thumbs-up">0</span></span>
          <span>ğŸ‘ <span class="thumbs-down">0</span></span>
      </div>
      <div class="report-comments">
        <h4>Maoni:</h4>
        <ul class="comments-list"></ul>
        <form class="comment-form">
          <input type="text" name="comment" placeholder="Andika maoni..." required>
          <button type="submit">Tuma</button>
        </form>
      </div>
    </div>
  </div>
</template>

<script>
const username    = "<%= username %>";
const loggedUser  = "<%= loggedInUser %>";
const reportsDiv  = document.getElementById('reports-container');
const tpl         = document.getElementById('cardTpl');

// Avatar
(async()=>{
  try{
    const uRes= await fetch(`/api/useravatar?u=${encodeURIComponent(username)}`);
    const {avatar} = await uRes.json();
    document.getElementById("userAvatar").src= avatar || '/default-avatar.png';
  }catch(e){/* ignore */}
})();

// Get reports
(async ()=>{
  try{
    const r = await fetch(`/api/reports?username=${encodeURIComponent(username)}`);
    const data = await r.json();
    fillStats(data.reports);
    data.reports.forEach(drawCard);
  }catch(e){
    reportsDiv.innerHTML="<p>Tatizo kupata ripoti...</p>";
  }
})();

function fillStats(list){
  const total   = list.length;
  const upCount = list.reduce((n,r)=>n+r.thumbs_up,0);
  const dnCount = list.reduce((n,r)=>n+r.thumbs_down,0);
  document.getElementById('totalPosts').innerText = total+' Ripoti';
  document.getElementById('totalThumbsUp').innerText = upCount+' ğŸ‘';
  document.getElementById('totalThumbsDown').innerText = dnCount+' ğŸ‘';
}

function drawCard(r){
  const clone = tpl.content.cloneNode(true);
  clone.querySelector('.report-title').innerText = r.title||"";
  clone.querySelector('.report-meta').innerText  = `${r.username} - ${r.clinic} | ${r.timestamp}`;
  clone.querySelector('.report-description').innerText = r.description;

  // avatar
  clone.querySelector('.report-avatar').src = r.avatar||"/default-avatar.png"; 

  // img
  if(r.image){
    const im = clone.querySelector('.report-image');
    im.src=r.image; im.style.display='block';
  }

  // thumbs
  clone.querySelector('.thumbs-up').innerText = r.thumbs_up;
  clone.querySelector('.thumbs-down').innerText = r.thumbs_down;
  if(username === loggedUser){
    clone.querySelector('.report-thumbs').style.pointerEvents="none";
  }

  // comments
  const ul = clone.querySelector('.comments-list');
  r.comments.forEach(c=>{
    const li = document.createElement('li');
    li.className='comment-item';
    li.innerHTML = `
      <img class="comment-avatar" src="${c.avatar||'/default-avatar.png'}">
      <div class="comment-content">
         <div class="comment-user">${c.username}</div>
         <div class="comment-text">${c.comment}</div>
         <div class="comment-time">${c.timestamp}</div>
      </div>
    `;
    ul.appendChild(li);
  });

  // send comment
  clone.querySelector('.comment-form').addEventListener('submit', async e=>{
    e.preventDefault();
    const txt = e.target.comment.value;
    if(!txt) return;
    const rr = await fetch(`/api/comments/${r.id}`,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({comment:txt})
    });
    const saved = await rr.json();
    const li = document.createElement('li');
    li.className='comment-item';
    li.innerHTML = `
      <img class="comment-avatar" src="${saved.avatar||'/default-avatar.png'}">
      <div class="comment-content">
         <div class="comment-user">${saved.username}</div>
         <div class="comment-text">${saved.comment}</div>
         <div class="comment-time">${saved.timestamp}</div>
      </div>`;
    ul.prepend(li);
    e.target.reset();
  });

  reportsDiv.appendChild(clone);
}
</script>
</body>
</html>
