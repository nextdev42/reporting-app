<!DOCTYPE html>
<html lang="sw">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ripoti za Kliniki</title>
  <style>
    /* Reset & body */
    * { box-sizing: border-box; margin:0; padding:0; font-family: Arial, sans-serif; }
    body { background: #f2f5f7; color: #333; line-height: 1.6; }

    /* Navbar */
    nav { background: #0066cc; color: white; padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; }
    nav a { color: white; text-decoration: none; margin-left: 15px; }
    nav a:hover { text-decoration: underline; }

    /* Container */
    .container { max-width: 900px; margin: 20px auto; padding: 0 15px; }

    h1, h2 { margin-bottom: 15px; }

    /* Report Card */
    .report-card { background: white; padding: 15px; margin-bottom: 20px; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    .report-card img { max-width: 100%; margin: 10px 0; border-radius: 4px; }

    /* Comments */
    .comments { margin-top: 10px; padding-top: 10px; border-top: 1px solid #ddd; }
    .comment { margin-bottom: 8px; }
    .comment strong { color: #0066cc; }
    .comment-input { display: flex; margin-top: 10px; }
    .comment-input input, .comment-input select { flex: 1; padding: 6px; margin-right: 5px; border-radius: 4px; border: 1px solid #ccc; }
    .comment-input button { padding: 6px 12px; border:none; border-radius:4px; background:#0066cc; color:white; cursor:pointer; }
    .comment-input button:hover { background:#004999; }

    /* Responsive */
    @media (max-width: 600px) {
      .comment-input { flex-direction: column; }
      .comment-input input, .comment-input select, .comment-input button { margin: 5px 0; width: 100%; }
    }
  </style>
</head>
<body>

  <nav>
    <div>ðŸ“‹ <strong>Ripoti za Kliniki</strong></div>
    <div><a href="index.html">Tuma Ripoti Mpya</a></div>
  </nav>

  <div class="container">
    <h1>Ripoti Zote</h1>
    <div id="reports"></div>
  </div>

  <script>
    const CLINICS = ["Kisiwani", "Jirambe", "Mikwambe", "Kibada"];
    
    async function fetchReports() {
      const res = await fetch("/api/reports");
      const data = await res.json();
      const container = document.getElementById("reports");
      container.innerHTML = "";

      if (data.length === 0) {
        container.innerHTML = "<p>Hakuna ripoti bado.</p>";
        return;
      }

      data.forEach(report => {
        const div = document.createElement("div");
        div.className = "report-card";
        div.innerHTML = `
          <p><strong>Muda:</strong> ${report.timestamp}</p>
          <p><strong>Jina la Mtumiaji:</strong> ${report.username}</p>
          <p><strong>Kliniki:</strong> ${report.clinic}</p>
          <p><strong>Kichwa:</strong> ${report.title}</p>
          <p><strong>Maelezo:</strong> ${report.description}</p>
          ${report.image ? `<img src="${report.image}" alt="Picha ya Ripoti">` : ""}
          <div class="comments">
            <h4>Maoni:</h4>
            <div id="comments-${report.id}">
              ${report.comments.map(c => `<p class="comment"><strong>${c.username} (${c.clinic}):</strong> ${c.comment}</p>`).join("")}
            </div>
            <div class="comment-input">
              <input type="text" placeholder="Jina lako" id="username-${report.id}">
              <select id="clinic-${report.id}">
                <option value="">Chagua Kliniki</option>
                ${CLINICS.map(c => `<option value="${c}">${c}</option>`).join("")}
              </select>
              <input type="text" placeholder="Andika maoni..." id="comment-${report.id}">
              <button onclick="addComment(${report.id})">Ongeza</button>
            </div>
          </div>
        `;
        container.appendChild(div);
      });
    }

    async function addComment(reportId) {
      const username = document.getElementById(`username-${reportId}`).value.trim();
      const clinic = document.getElementById(`clinic-${reportId}`).value;
      const comment = document.getElementById(`comment-${reportId}`).value.trim();

      if (!username || !clinic || !comment) {
        alert("Tafadhali jaza jina, kliniki na maoni.");
        return;
      }

      const res = await fetch("/comment", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ report_id: reportId, username, clinic, comment })
      });

      const data = await res.json();
      if (res.ok) {
        document.getElementById(`comments-${reportId}`).innerHTML += `
          <p class="comment"><strong>${username} (${clinic}):</strong> ${comment}</p>
        `;
        document.getElementById(`username-${reportId}`).value = "";
        document.getElementById(`clinic-${reportId}`).value = "";
        document.getElementById(`comment-${reportId}`).value = "";
      } else {
        alert(data.error || "Kuna tatizo kuhifadhi maoni.");
      }
    }

    fetchReports();
  </script>
</body>
</html>
