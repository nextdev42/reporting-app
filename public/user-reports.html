<!DOCTYPE html>
<html lang="sw">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ripoti za Mtumiaji</title>
<link rel="stylesheet" href="dashboard.css">
</head>
<body>

<nav>
  <h1>Ripoti za <span id="usernameTitle"></span></h1>
  <div class="nav-actions">
    <button onclick="location.href='/'">Nyumbani</button>
    <button onclick="location.href='/logout'">Toka</button>
  </div>
</nav>

<div class="container">
  <div class="reports-section">
    <h2>Ripoti Zilizowasilishwa</h2>
    <div id="userReportsContainer"></div>
  </div>
</div>

<script>
// Assume 'reports' and 'username' are passed from backend, e.g. via template engine
// Example placeholder for testing:
const username = "<%= username %>"; 
const reports = <%= JSON.stringify(reports) %>;

document.getElementById("usernameTitle").textContent = username;

function formatDate(ts) {
  const d = new Date(ts);
  return d.toLocaleString("sw-TZ");
}

function highlightMentions(text) {
  return text.replace(/@(\w+)/g, '<a href="/user/$1">@$1</a>');
}

function renderReportCard(report) {
  const card = document.createElement("div");
  card.className = "report-card";

  card.innerHTML = `
    <div class="report-header">
      <div class="avatar" onclick="location.href='/user/${report.username}'">
        ${report.username.charAt(0).toUpperCase()}
      </div>
      <div class="user-info">
        <span class="username" onclick="location.href='/user/${report.username}'">${report.username}</span>
        <span class="clinic">${report.clinic}</span>
      </div>
    </div>

    ${report.image ? `<div class="report-image"><img src="${report.image}" alt="Ripoti"></div>` : ""}

    <div class="report-caption">${highlightMentions(report.description)}</div>

    <div class="report-actions">
      <button class="thumb-up">üëç ${report.thumbs_up || 0}</button>
      <button class="thumb-down">üëé ${report.thumbs_down || 0}</button>
      <span class="comment-toggle">üí¨</span>
    </div>

    <div class="comments-section">
      <div class="commentsList">
        ${report.comments.map(c => `
          <div class="comment-item">
            <div class="comment-header">
              <span class="username" onclick="location.href='/user/${c.username}'">
                ${c.username} (${c.clinic})
              </span>
              <span class="time">${formatDate(c.timestamp)}</span>
            </div>
            <p>${highlightMentions(c.comment)}</p>
          </div>
        `).join('')}
      </div>

      <div class="comment-input">
        <input type="text" placeholder="Andika maoni yako" name="commentText">
        <div class="mentionBox" style="display:none;"></div>
        <button class="sendCommentBtn">Tuma</button>
      </div>
    </div>
  `;

  // Chat toggle
  const toggle = card.querySelector(".comment-toggle");
  const inputBox = card.querySelector(".comment-input");
  toggle.addEventListener("click", () => {
    inputBox.style.display = inputBox.style.display === "flex" ? "none" : "flex";
  });

  return card;
}

const container = document.getElementById("userReportsContainer");
reports.forEach(r => container.appendChild(renderReportCard(r)));
</script>

</body>
</html>
