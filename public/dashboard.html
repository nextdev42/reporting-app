<!DOCTYPE html>
<html lang="sw">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard | Pilimissana Sober House</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="dashboard.css">
</head>
<body>
  <nav class="navbar">
    <div class="logo">Pilimissana</div>
    <ul class="nav-links">
      <li><a href="/logout">Logout</a></li>
    </ul>
  </nav>

  <main>
    <section class="greeting">
      <h1 id="greeting-text">Habari, <span id="username"></span>!</h1>
      <p>Kituo chako: <span id="clinic"></span></p>
    </section>

    <section class="report-form">
      <h2>Tuma Ripoti</h2>
      <form id="reportForm" action="/submit" method="POST" enctype="multipart/form-data">
        <input type="text" name="title" placeholder="Kichwa cha ripoti" required>
        <textarea name="description" placeholder="Maelezo ya ripoti" required></textarea>
        <input type="file" name="image" accept="image/*">
        <button type="submit">Tuma</button>
      </form>
    </section>

    <section class="reports-section">
      <h2>Ripoti Zote</h2>
      <div id="reports-container"></div>
    </section>
  </main>

  <script>
    // Fetch user info
    fetch("/api/user")
      .then(res => res.json())
      .then(user => {
        const usernameEl = document.getElementById("username");
        const clinicEl = document.getElementById("clinic");
        usernameEl.textContent = user.jina;
        clinicEl.textContent = user.kituo;

        // Dynamic greeting
        const now = new Date();
        const hour = now.getHours();
        let greeting = "Habari za usiku";
        if (hour >= 5 && hour < 12) greeting = "Habari ya asubuhi";
        else if (hour >= 12 && hour < 17) greeting = "Habari za mchana";
        else if (hour >= 17 && hour < 20) greeting = "Habari za jioni";

        document.getElementById("greeting-text").textContent = `${greeting}, ${user.jina}!`;
      });

    // Fetch reports
    function loadReports() {
      fetch("/api/reports")
        .then(res => res.json())
        .then(reports => {
          const container = document.getElementById("reports-container");
          container.innerHTML = "";
          reports.forEach(rep => {
            const div = document.createElement("div");
            div.classList.add("report-card");
            div.innerHTML = `
              <h3>${rep.title}</h3>
              <p>${rep.description}</p>
              ${rep.image ? `<img src="${rep.image}" alt="report image">` : ""}
              <small>Imechapishwa na: ${rep.username} | ${rep.clinic} | ${rep.timestamp}</small>
              <div class="comments">
                <h4>Maoni</h4>
                <div>${rep.comments.map(c => `<p><strong>${c.username}:</strong> ${c.comment}</p>`).join('')}</div>
                <form class="commentForm" data-id="${rep.id}">
                  <input type="text" name="comment" placeholder="Andika maoni..." required>
                  <button type="submit">Tuma</button>
                </form>
              </div>
            `;
            container.appendChild(div);
          });

          // Comment form submission
          document.querySelectorAll(".commentForm").forEach(form => {
            form.addEventListener("submit", function(e) {
              e.preventDefault();
              const id = this.dataset.id;
              const comment = this.comment.value;
              fetch(`/api/comments/${id}`, {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({comment})
              }).then(() => {
                this.comment.value = "";
                loadReports(); // reload reports
              });
            });
          });
        });
    }

    loadReports();
  </script>
</body>
</html>
