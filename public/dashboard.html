<!DOCTYPE html>
<html lang="sw">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard ya Ripoti</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      background: #f0f2f5;
      color: #333;
    }
    nav {
      background: #007BFF;
      color: #fff;
      padding: 10px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    nav a {
      color: #fff;
      text-decoration: none;
      margin-left: 15px;
      font-weight: bold;
    }
    nav a:hover { text-decoration: underline; }

    .container {
      max-width: 900px;
      margin: 20px auto;
      padding: 20px;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    h2 { color: #007BFF; }
    input, select, textarea, button {
      width: 100%;
      padding: 8px;
      margin: 5px 0 15px 0;
      border-radius: 4px;
      border: 1px solid #ccc;
      font-size: 14px;
    }
    button {
      background: #007BFF;
      color: #fff;
      border: none;
      cursor: pointer;
    }
    button:hover { background: #0056b3; }

    .report-card {
      border: 1px solid #ccc;
      border-radius: 6px;
      padding: 12px;
      margin-bottom: 20px;
      background: #f9f9f9;
    }
    .report-card img {
      max-width: 100%;
      margin-top: 10px;
      border-radius: 4px;
    }
    .comment-section {
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid #ccc;
    }
    .comment-card {
      background: #e9ecef;
      padding: 6px 8px;
      margin-bottom: 6px;
      border-radius: 4px;
    }

    @media (max-width: 600px) {
      .container { padding: 10px; }
      nav { flex-direction: column; align-items: flex-start; }
      nav a { margin: 5px 0 0 0; }
    }
  </style>
</head>
<body>

<nav>
  <div>Dashboard ya Ripoti</div>
  <div>
    <a href="#create-report">Tuma Ripoti</a>
    <a href="#view-reports">Angalia Ripoti</a>
  </div>
</nav>

<div class="container" id="create-report">
  <h2>Tuma Ripoti</h2>
  <form id="reportForm">
    <input name="username" placeholder="Jina la Mtumiaji" required />
    <select name="clinic" required>
      <option value="">Chagua Kliniki</option>
      <option value="Kisiwani">Kisiwani</option>
      <option value="Jirambe">Jirambe</option>
      <option value="Mikwambe">Mikwambe</option>
      <option value="Kibada">Kibada</option>
    </select>
    <input name="title" placeholder="Kichwa cha Ripoti" required />
    <textarea name="description" placeholder="Maelezo ya Ripoti" required></textarea>
    <input type="file" name="image" accept="image/*" />
    <button type="submit">Tuma Ripoti</button>
  </form>
  <p id="formStatus"></p>
</div>

<div class="container" id="view-reports">
  <h2>Ripoti Zote</h2>
  <div id="reportsContainer"></div>
</div>

<script>
const form = document.getElementById("reportForm");
const formStatus = document.getElementById("formStatus");
const reportsContainer = document.getElementById("reportsContainer");

form.addEventListener("submit", async (e) => {
  e.preventDefault();
  formStatus.textContent = "Inatumwa...";
  const data = new FormData(form);

  try {
    const res = await fetch("/submit", { method: "POST", body: data });
    const text = await res.text();
    formStatus.textContent = text;
    if(res.ok){ form.reset(); fetchReports(); }
  } catch(err) {
    formStatus.textContent = "Kuna tatizo: " + err.message;
  }
});

async function fetchReports(){
  reportsContainer.innerHTML = "Inapakia...";
  try {
    const res = await fetch("/api/reports");
    const reports = await res.json();
    if(reports.length===0){ reportsContainer.innerHTML="<p>Hakuna ripoti.</p>"; return; }

    reportsContainer.innerHTML = "";
    reports.forEach(r=>{
      const card = document.createElement("div");
      card.className="report-card";

      let html = `<p><strong>Muda:</strong> ${r.timestamp}</p>
                  <p><strong>Jina la Mtumiaji:</strong> ${r.username}</p>
                  <p><strong>Kliniki:</strong> ${r.clinic}</p>
                  <p><strong>Kichwa:</strong> ${r.title}</p>
                  <p><strong>Maelezo:</strong> ${r.description}</p>`;
      if(r.image) html+=`<img src="${r.image}" alt="picha ya ripoti">`;

      html += `<div class="comment-section">
                <h4>Maoni</h4>
                <div id="comments-${r.id}">`;
      if(r.comments.length===0){ html+='<p>Hakuna maoni.</p>'; }
      else { r.comments.forEach(c=>{
        html += `<div class="comment-card"><strong>${c.username} (${c.clinic}) [${c.timestamp}]:</strong> ${c.comment}</div>`;
      }); }
      html += `</div>
                <input type="text" placeholder="Jina lako" id="username-${r.id}" />
                <select id="clinic-${r.id}">
                  <option value="">Chagua Kliniki</option>
                  <option value="Kisiwani">Kisiwani</option>
                  <option value="Jirambe">Jirambe</option>
                  <option value="Mikwambe">Mikwambe</option>
                  <option value="Kibada">Kibada</option>
                </select>
                <input type="text" id="comment-${r.id}" placeholder="Andika maoni yako" />
                <button onclick="addComment(${r.id})">Ongeza Maoni</button>
              </div>`;
      card.innerHTML = html;
      reportsContainer.appendChild(card);
    });
  } catch(err){ reportsContainer.innerHTML="Kuna tatizo: "+err.message; }
}

async function addComment(reportId){
  const username = document.getElementById(`username-${reportId}`).value;
  const clinic = document.getElementById(`clinic-${reportId}`).value;
  const comment = document.getElementById(`comment-${reportId}`).value;
  if(!username || !clinic || !comment){ alert("Jaza sehemu zote za maoni."); return; }

  try{
    const res = await fetch(`/api/comments/${reportId}`,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({username,clinic,comment})
    });
    if(res.ok){ fetchReports(); } else { alert("Kuna tatizo kuingiza maoni."); }
  } catch(err){ alert("Kuna tatizo: "+err.message); }
}

fetchReports();
</script>

</body>
</html>
