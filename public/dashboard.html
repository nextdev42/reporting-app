<!DOCTYPE html>
<html lang="sw">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashibodi ya Ripoti za Kliniki</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; background:#f5f5f5; color:#333; }
    nav { background:#4CAF50; color:white; padding:10px 20px; display:flex; justify-content:space-between; align-items:center; }
    nav h1 { margin:0; font-size:1.5rem; }
    nav .nav-actions { display:flex; gap:12px; align-items:center; }
    nav button { background:white; color:#4CAF50; border:none; padding:8px 12px; cursor:pointer; border-radius:4px; font-weight:bold; }
    nav button:hover { background:#e0e0e0; }
    .container { max-width:900px; margin:20px auto; padding:0 15px; }
    .greeting { margin:15px 0; font-size:1.2rem; font-weight:bold; color:#333; }
    .form-section, .reports-section { background:white; padding:20px; border-radius:8px; margin-bottom:20px; box-shadow:0 2px 5px rgba(0,0,0,0.1); }
    .form-section h2, .reports-section h2 { margin-top:0; color:#4CAF50; }
    input, select, textarea { width:100%; padding:8px; margin:6px 0 12px 0; border:1px solid #ccc; border-radius:4px; box-sizing:border-box; }
    button.submit-btn { background:#4CAF50; color:white; border:none; padding:10px 15px; cursor:pointer; border-radius:4px; font-weight:bold; }
    button.submit-btn:hover { background:#45a049; }
    .report-card { border:1px solid #ddd; padding:12px; margin-bottom:15px; border-radius:8px; background:#fafafa; display:flex; flex-direction:column; position:relative; }
    .report-card img { max-width:100%; margin-top:10px; border-radius:4px; }
    .comments { margin-top:15px; display:flex; flex-direction:column; gap:10px; }
    .commentsList { max-height:250px; overflow-y:auto; display:flex; flex-direction:column; gap:8px; margin-bottom:8px; }
    .comment-item { background:#e8f5e9; padding:10px 14px; border-radius:15px; box-shadow:0 1px 3px rgba(0,0,0,0.08); word-wrap:break-word; font-size:0.9rem; }
    .comment-header{ display:flex; justify-content:space-between; margin-bottom:4px; font-weight:600; }
    .comment-header span.username{ color:#2e7d32; }
    .comment-header span.time{ font-size:0.75rem; color:#555; }
    .comments input[type="text"]{ width:80%; padding:10px 15px; border-radius:20px; border:1px solid #ccc; font-size:0.9rem; }
    .comments button{ width:18%; padding:10px; border-radius:20px; border:none; background:#4CAF50; color:white; font-weight:600; cursor:pointer; margin-left:2%; }
    @media(max-width:600px){ .comments input[type="text"],.comments button{ width:100%; margin-bottom:6px; } }
  </style>
</head>
<body>
  <nav>
    <h1>Dashibodi ya Ripoti za Kliniki</h1>
    <div class="nav-actions">
      <button id="toggleFormBtn">Ongeza Ripoti</button>
      <button onclick="location.href='/logout'">Toka</button>
    </div>
  </nav>

  <div class="container">
    <div class="greeting" id="greeting">Habari...</div>

    <!-- Form to add report -->
    <div class="form-section" id="reportFormSection" style="display:none;">
      <h2>Ongeza Ripoti</h2>
      <form id="reportForm">
        <input type="text" name="title" placeholder="Kichwa" required>
        <textarea name="description" placeholder="Maelezo" required></textarea>
        <input type="file" name="image" accept="image/*">
        <button type="submit" class="submit-btn">Tuma Ripoti</button>
      </form>
      <p id="formStatus"></p>
    </div>

    <!-- Filter section -->
    <div class="form-section">
      <h2>Tafuta/Filter Ripoti</h2>
      <div style="display:flex; gap:12px; flex-wrap:wrap;">
        <select id="clinicFilter">
          <option value="">Chagua Kliniki</option>
          <option value="Mikwambe">Mikwambe</option>
          <option value="Kigogo">Kigogo</option>
          <!-- add more clinics -->
        </select>
        <input type="text" id="usernameFilter" placeholder="Tafuta kwa jina la mtumiaji">
        <input type="text" id="globalSearch" placeholder="Tafuta title, maelezo au comment">
        <button id="applyFiltersBtn">Tafuta</button>
        <button id="clearFiltersBtn">Ongeza zote</button>
      </div>
    </div>

    <!-- Reports container -->
    <div class="reports-section">
      <h2>Ripoti Zilizowasilishwa</h2>
      <div id="reportsContainer"></div>
      <div id="pagination" style="margin-top:10px; display:flex; gap:5px; flex-wrap:wrap;"></div>
    </div>
  </div>

  <script>
    const toggleFormBtn = document.getElementById("toggleFormBtn");
    const reportFormSection = document.getElementById("reportFormSection");
    const reportForm = document.getElementById("reportForm");
    const formStatus = document.getElementById("formStatus");
    const reportsContainer = document.getElementById("reportsContainer");
    const greeting = document.getElementById("greeting");

    toggleFormBtn.addEventListener("click", () => {
      reportFormSection.style.display = reportFormSection.style.display === "none" ? "block" : "none";
      toggleFormBtn.textContent = reportFormSection.style.display === "none" ? "Ongeza Ripoti" : "Ficha Fomu";
    });

    async function loadGreeting(){
      const res = await fetch("/api/user");
      const user = await res.json();
      const now = new Date();
      const t = new Date(now.getTime()+(3*60+now.getTimezoneOffset())*60000);
      const h = t.getHours();
      let g = "Habari";
      if(h>=5&&h<12) g="Habari ya asubuhi";
      else if(h>=12&&h<17) g="Habari ya mchana";
      else if(h>=17&&h<21) g="Habari ya jioni";
      else g="Habari usiku";
      greeting.textContent = `${g} ${user.jina} ${user.kituo}`;
    }
    loadGreeting();

    let currentPage = 1;

    async function fetchReports(page = 1){
      reportsContainer.innerHTML="Inapakia ripoti...";
      const clinic = document.getElementById("clinicFilter").value.trim();
      const username = document.getElementById("usernameFilter").value.trim();
      const search = document.getElementById("globalSearch").value.trim();

      const params = new URLSearchParams({ page, limit:15 });
      if(clinic) params.append("clinic", clinic);
      if(username) params.append("username", username);
      if(search) params.append("search", search);

      const res = await fetch("/api/reports?" + params.toString());
      const data = await res.json();
      reportsContainer.innerHTML = "";
      const pagination = document.getElementById("pagination");
      pagination.innerHTML = "";

      if(!data.reports.length){ reportsContainer.innerHTML="<p>Hakuna ripoti zilizopatikana.</p>"; return; }

      data.reports.forEach(report=>{
        const card=document.createElement("div");
        card.className="report-card";
        card.innerHTML=`
          <p><strong>Muda:</strong> ${report.timestamp}</p>
          <p><strong>Jina la Mtumiaji:</strong> ${report.username}</p>
          <p><strong>Kliniki:</strong> ${report.clinic}</p>
          <p><strong>Kichwa:</strong> ${report.title}</p>
          <p><strong>Maelezo:</strong> ${report.description}</p>
          ${report.image?`<img src="${report.image}" alt="Ripoti">`:""}
          <div class="comments">
            <h4>Maoni:</h4>
            <div class="commentsList">
              ${report.comments.map(c=>`
                <div class="comment-item">
                  <div class="comment-header">
                    <span class="username">${c.username} (${c.clinic})</span>
                    <span class="time">${c.timestamp}</span>
                  </div>
                  <p>${c.comment}</p>
                </div>
              `).join('')}
            </div>
            <input type="text" placeholder="Andika maoni yako" name="commentText">
            <button>Add</button>
          </div>`;
        const commentBtn = card.querySelector(".comments button");
        commentBtn.addEventListener("click", async ()=>{
          const inp = card.querySelector("input[name='commentText']");
          const txt = inp.value.trim();
          if(!txt) return alert("Andika maoni yako.");
          await fetch(`/api/comments/${report.id}`, {
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body: JSON.stringify({comment:txt})
          });
          inp.value="";
          fetchReports(currentPage);
        });
        reportsContainer.appendChild(card);
      });

      setupPagination(data.page, data.totalPages);
    }

    function setupPagination(page, totalPages){
      currentPage = page;
      const pagination = document.getElementById("pagination");
      pagination.innerHTML = "";
      for(let i=1;i<=totalPages;i++){
        const btn=document.createElement("button");
        btn.textContent = i;
        btn.disabled = i===page;
        btn.addEventListener("click",()=>fetchReports(i));
        pagination.appendChild(btn);
      }
    }

    document.getElementById("applyFiltersBtn").addEventListener("click",()=>fetchReports(1));
    document.getElementById("clearFiltersBtn").addEventListener("click",()=>{
      document.getElementById("clinicFilter").value="";
      document.getElementById("usernameFilter").value="";
      document.getElementById("globalSearch").value="";
      fetchReports(1);
    });

    fetchReports();

    reportForm.addEventListener("submit", async e=>{
      e.preventDefault();
      formStatus.textContent="Inatuma ripoti...";
      const fd = new FormData(reportForm);
      const res = await fetch("/submit",{ method:"POST", body:fd });
      if(!res.ok){ formStatus.textContent="Tatizo: "+await res.text(); return; }
      formStatus.textContent="Ripoti imehifadhiwa!";
      reportForm.reset();
      fetchReports();
    });
  </script>
</body>
</html>
