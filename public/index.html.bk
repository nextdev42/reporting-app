<!DOCTYPE html>
<html lang="sw">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ingia / Jisajili - Ripoti za Kliniki</title>
  <style>
    /* ... (keep your existing styles) ... */
  </style>
</head>
<body>

<div class="auth-container">
  <h2 id="formTitle">Ingia</h2>

  <div id="errorMsg" class="error-message"></div>

  <!-- Login Form -->
  <form id="loginForm">
    <input type="text" name="jina" placeholder="Jina la mtumiaji" required>
    <input type="password" name="password" placeholder="Password" required>
    <button type="submit">Ingia</button>
  </form>

  <!-- Register Form (hidden by default) -->
  <form id="registerForm" style="display:none;">
    <input type="text" name="jina" placeholder="Jina" required>
    <input type="text" name="ukoo" placeholder="Jina la ukoo" required>
    <input type="text" name="namba" placeholder="Namba ya simu" required>
    <select name="kituo" required>
      <option value="">Chagua Kituo</option>
      <option value="Kisiwani">Kisiwani</option>
      <option value="Jirambe">Jirambe</option>
      <option value="Mikwambe">Mikwambe</option>
      <option value="Kibada">Kibada</option>
    </select>
    <input type="password" name="password" placeholder="Password" required>
    <input type="password" name="confirmPassword" placeholder="Confirm Password" required>
    <button type="submit">Jisajili</button>
  </form>

  <div class="toggle-link" id="toggleForm">Tafuta akaunti? Jisajili hapa</div>
</div>

<script>
  const loginForm = document.getElementById("loginForm");
  const registerForm = document.getElementById("registerForm");
  const toggleForm = document.getElementById("toggleForm");
  const formTitle = document.getElementById("formTitle");
  const errorMsg = document.getElementById("errorMsg");

  toggleForm.addEventListener("click", () => {
    if (loginForm.style.display === "none") {
      loginForm.style.display = "block";
      registerForm.style.display = "none";
      formTitle.textContent = "Ingia";
      toggleForm.textContent = "Tafuta akaunti? Jisajili hapa";
      errorMsg.textContent = "";
    } else {
      loginForm.style.display = "none";
      registerForm.style.display = "block";
      formTitle.textContent = "Jisajili";
      toggleForm.textContent = "Tayari una akaunti? Ingia hapa";
      errorMsg.textContent = "";
    }
  });

  loginForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    errorMsg.textContent = "";
    const formData = new FormData(loginForm);
    const data = Object.fromEntries(formData.entries());

    try {
      const res = await fetch("/login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
      });
      
      if (!res.ok) {
        errorMsg.textContent = await res.text();
        return;
      }
      
      // Redirect to dashboard route, not HTML file
      window.location.href = "/dashboard";
    } catch (err) {
      errorMsg.textContent = "Tatizo kuingia: " + err.message;
    }
  });

  registerForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    errorMsg.textContent = "";
    const formData = new FormData(registerForm);
    const data = Object.fromEntries(formData.entries());

    if(data.password !== data.confirmPassword){
      errorMsg.textContent = "Password na confirm password lazima ziwe sawa.";
      return;
    }

    try {
      const res = await fetch("/register", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
      });
      
      if (!res.ok) {
        errorMsg.textContent = await res.text();
        return;
      }
      
      alert("Umejisajili kwa mafanikio. Ingia sasa.");
      toggleForm.click();
    } catch(err) {
      errorMsg.textContent = "Tatizo: " + err.message;
    }
  });

  // Fixed session checking
  async function checkSession() {
    try {
      const res = await fetch("/api/user");
      
      // Only redirect if we get a successful response (200 OK)
      if (res.ok) {
        // Use server-side dashboard route
        window.location.href = "/dashboard";
      }
      // Otherwise, stay on login page
    } catch {
      // Ignore errors (user not authenticated)
    }
  }
  
  checkSession();
</script>

</body>
</html>
